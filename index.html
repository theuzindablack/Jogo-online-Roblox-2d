<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer 2D Completo</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#1e272e;font-family:sans-serif;touch-action:none}
canvas{display:block;background:#2ecc71}
#setup{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;z-index:10}
input,button{padding:12px;margin:5px;border:none;border-radius:8px;outline:none}
button{cursor:pointer;color:#fff;font-weight:bold}
#hud{position:absolute;top:10px;left:10px;background:#000a;color:#fff;padding:10px;border-radius:8px;pointer-events:none}
#chatWrap{position:absolute;bottom:20px;right:20px;width:260px;z-index:20}
#chat{display:none;flex-direction:column;background:#000c;border-radius:8px;height:200px;margin-bottom:10px}
#msgs{flex:1;overflow-y:auto;color:#fff;font-size:12px;padding:8px}
#chat input{border:none;padding:10px;background:#fff2;color:#fff;border-radius:0 0 8px 8px;width:calc(100% - 20px)}
#btnChat{width:50px;height:50px;border-radius:50%;background:#3498db;font-size:20px;border:none;float:right}
#joystick{position:absolute;bottom:40px;left:40px;width:120px;height:120px;border-radius:50%;background:#fff2}
#stick{position:absolute;left:40px;top:40px;width:40px;height:40px;background:#fff;border-radius:50%;pointer-events:none}
</style>
</head>
<body>

<div id="setup">
Â  <h2>MULTIPLAYER</h2>
Â  <input id="nameIn" placeholder="Nome" value="Player">
Â  <input id="roomIn" placeholder="Sala" value="ABC123">
Â  <div style="display:flex;">
Â  Â  <button style="background:#27ae60" onclick="start(true)">CRIAR</button>
Â  Â  <button style="background:#2980b9" onclick="start(false)">ENTRAR</button>
Â  </div>
</div>

<div id="hud">
Â  <div id="status">Offline</div>
Â  <div id="count">Jogadores: 1 / 5</div>
</div>

<div id="chatWrap">
Â  <div id="chat">
Â  Â  <div id="msgs"></div>
Â  Â  <input id="chatInput" placeholder="Mensagem (mÃ¡x 60)">
Â  </div>
Â  <button id="btnChat" onclick="toggleChat()">ðŸ’¬</button>
</div>

<canvas id="game"></canvas>
<div id="joystick"><div id="stick"></div></div>

<script>
const MAX_PLAYERS=5;
const canvas=game, ctx=canvas.getContext("2d");
canvas.width=innerWidth; canvas.height=innerHeight;

let peer, isHost=false, ready=false;
let eu, outros={}, conns=[], joinOrder=[];

// INICIAR
function start(host){
Â  isHost=host;
Â  const nome=nameIn.value||"Player";
Â  const sala=roomIn.value||"ABC123";
Â  const id=host?"H_"+sala:"P_"+Math.random().toString(36).slice(2);

Â  eu={id,name:nome,x:300,y:300,color:"#"+(Math.random()*0xffffff|0).toString(16).padStart(6,"0"),msg:"",msgTime:0};

Â  setup.style.display="none";
Â  peer=new Peer(id);

Â  peer.on("error",err=>{alert("Erro: "+err.type);location.reload();});

Â  peer.on("open",()=>{
Â  Â  if(isHost){ status.textContent="HOST "+sala; joinOrder=[eu.id]; ready=true; }
Â  Â  else setupConn(peer.connect("H_"+sala));
Â  });

Â  peer.on("connection",setupConn);
}

// CONFIGURAR CONEXÃ•ES
function setupConn(c){
Â  c.on("open",()=>{
Â  Â  if(isHost){
Â  Â  Â  if(conns.length+1>=MAX_PLAYERS){c.send({t:"full"}); c.close(); return;}
Â  Â  Â  conns.push(c);
Â  Â  }else{conns=[c]; status.textContent="Online";}
Â  Â  c.send({t:"join",p:eu});
Â  });

Â  c.on("data",d=>{
Â  Â  if(!d||!d.t)return;

Â  Â  if(d.t==="full"){alert("Sala cheia!"); location.reload();}

Â  Â  if(d.t==="join"){
Â  Â  Â  outros[d.p.id]=d.p;
Â  Â  Â  if(!joinOrder.includes(d.p.id)) joinOrder.push(d.p.id);
Â  Â  Â  addMsg("Sistema", d.p.name+" entrou");
Â  Â  Â  if(isHost) broadcast({t:"sync",all:{...outros,[eu.id]:eu},order:joinOrder});
Â  Â  }

Â  Â  if(d.t==="sync"){
Â  Â  Â  for(let i in d.all) if(i!==eu.id) outros[i]=d.all[i];
Â  Â  Â  for(let i in outros) if(!d.all[i]) delete outros[i];
Â  Â  Â  joinOrder=d.order;
Â  Â  Â  ready=true;
Â  Â  }

Â  Â  if(d.t==="move"){
Â  Â  Â  if(outros[d.id]){outros[d.id].x=d.x; outros[d.id].y=d.y;}
Â  Â  Â  if(isHost) broadcast(d,c.peer);
Â  Â  }

Â  Â  if(d.t==="chat"){
Â  Â  Â  const p=(d.id===eu.id)?eu:outros[d.id];
Â  Â  Â  if(p){p.msg=d.msg; p.msgTime=Date.now();}
Â  Â  Â  addMsg(d.name,d.msg);
Â  Â  Â  if(isHost) broadcast(d,c.peer);
Â  Â  }

Â  Â  if(d.t==="leave"){
Â  Â  Â  if(outros[d.id]) addMsg("Sistema", outros[d.id].name+" saiu");
Â  Â  Â  delete outros[d.id];
Â  Â  Â  joinOrder=joinOrder.filter(i=>i!==d.id);
Â  Â  Â  if(isHost) broadcast(d,c.peer);
Â  Â  }

Â  Â  count.textContent=`Jogadores: ${Object.keys(outros).length+1} / ${MAX_PLAYERS}`;
Â  });

Â  c.on("close",()=>{
Â  Â  const idSaiu=c.peer;
Â  Â  if(outros[idSaiu]) addMsg("Sistema", outros[idSaiu].name+" saiu");
Â  Â  delete outros[idSaiu];
Â  Â  joinOrder=joinOrder.filter(i=>i!==idSaiu);

Â  Â  if(isHost){
Â  Â  Â  conns=conns.filter(conn=>conn.peer!==idSaiu);
Â  Â  Â  broadcast({t:"leave",id:idSaiu});
Â  Â  } else if(idSaiu.startsWith("H_")){
Â  Â  Â  // O host saiu
Â  Â  Â  if(joinOrder[0]===eu.id) becomeHost();
Â  Â  Â  else alert("O host saiu! Aguarde reconexÃ£o...");
Â  Â  }

Â  Â  count.textContent=`Jogadores: ${Object.keys(outros).length+1} / ${MAX_PLAYERS}`;
Â  });
}

function broadcast(m,ignore){conns.forEach(c=>{if(c.open&&c.peer!==ignore)c.send(m);});}

// SE TORNAR HOST
function becomeHost(){
Â  alert("O host saiu! VocÃª agora Ã© o host.");
Â  isHost=true;
Â  peer.disconnect(); peer.destroy();
Â  const sala=roomIn.value||"ABC123";
Â  peer=new Peer("H_"+sala);

Â  peer.on("open",()=>{status.textContent="HOST "+sala; ready=true; broadcast({t:"sync",all:{...outros,[eu.id]:eu},order:joinOrder});});
Â  peer.on("connection",setupConn);

Â  // Reconectar clientes
Â  for(let i in outros){
Â  Â  if(i!==eu.id){
Â  Â  Â  const c=peer.connect(i); setupConn(c);
Â  Â  }
Â  }
}

// CHAT
function toggleChat(){chat.style.display=chat.style.display==="flex"?"none":"flex";}
function addMsg(n,t){const d=document.createElement("div"); const b=document.createElement("b"); b.textContent=n+": "; d.appendChild(b); d.appendChild(document.createTextNode(t)); msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight;}

chatInput.onkeydown=e=>{
Â  if(e.key==="Enter"&&e.target.value.trim()){
Â  Â  const m=e.target.value.slice(0,60);
Â  Â  eu.msg=m; eu.msgTime=Date.now();
Â  Â  addMsg("VocÃª",m);
Â  Â  const d={t:"chat",id:eu.id,name:eu.name,msg:m};
Â  Â  isHost?broadcast(d):conns[0]?.send(d);
Â  Â  e.target.value="";
Â  }
};

// JOYSTICK
let joy={x:0,y:0},active=false;
joystick.onmousedown=()=>active=true;
window.onmousemove=e=>active&&moveJoy(e);
window.onmouseup=resetJoy;
joystick.ontouchstart=e=>{active=true;moveJoy(e.touches[0]);};
joystick.ontouchmove=e=>moveJoy(e.touches[0]);
joystick.ontouchend=resetJoy;

function moveJoy(e){
Â  const r=joystick.getBoundingClientRect();
Â  let dx=e.clientX-r.left-60, dy=e.clientY-r.top-60;
Â  const d=Math.hypot(dx,dy); if(d>40){dx*=40/d;dy*=40/d;}
Â  joy.x=dx/40; joy.y=dy/40; stick.style.transform=`translate(${dx}px,${dy}px)`;
}
function resetJoy(){active=false;joy={x:0,y:0};stick.style.transform="translate(0,0)";}

// LOOP
function loop(){
Â  requestAnimationFrame(loop);
Â  if(!ready) return;
Â  if(joy.x||joy.y){eu.x+=joy.x*5; eu.y+=joy.y*5; const m={t:"move",id:eu.id,x:eu.x,y:eu.y}; isHost?broadcast(m):conns[0]?.send(m);}
Â  ctx.clearRect(0,0,canvas.width,canvas.height);
Â  const camX=eu.x-canvas.width/2, camY=eu.y-canvas.height/2;
Â  draw(eu,true);
Â  for(let i in outros) draw(outros[i]);

Â  function draw(p,me){
Â  Â  const x=p.x-camX, y=p.y-camY;
Â  Â  ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(x,y,25,0,Math.PI*2); ctx.fill();
Â  Â  ctx.strokeStyle="#fff"; ctx.stroke();
Â  Â  ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.fillText(me?p.name+" (EU)":p.name,x,y-35);
Â  Â  if(p.msg && Date.now()-p.msgTime<4000){
Â  Â  Â  const w=ctx.measureText(p.msg).width;
Â  Â  Â  ctx.fillStyle="rgba(0,0,0,.7)";
Â  Â  Â  ctx.fillRect(x-w/2-10,y-72,w+20,24);
Â  Â  Â  ctx.fillStyle="#fff"; ctx.fillText(p.msg,x,y-55);
Â  Â  }
Â  }
}
loop();
</script>
</body>
</html>
