<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer 2D - Personagens Separados</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    body, html { margin:0; padding:0; overflow:hidden; background:#6ab04c; touch-action:none; font-family: sans-serif; }
    canvas { display:block; background:#7bed9f; }
    #joystick { position:absolute; bottom:50px; left:50px; width:120px; height:120px; background:rgba(255,255,255,0.3); border-radius:50%; z-index:10; touch-action: none; cursor: pointer; }
    #stick { position:absolute; left:40px; top:40px; width:40px; height:40px; background:rgba(255,255,255,0.8); border-radius:50%; pointer-events: none; }
    #ui { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.8); color:white; padding:15px; border-radius:10px; z-index: 70; font-size: 14px; }
    #setup { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; }
    input { padding: 10px; margin: 5px; border-radius: 5px; border: none; width: 200px; }
    button { padding: 12px 25px; margin: 10px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; color: white; }
</style>
</head>
<body>

<div id="setup">
    <h1>MULTI JOGADOR - FIX</h1>
    <input type="text" id="nameIn" placeholder="Seu Nome" value="Player">
    <input type="text" id="roomIn" placeholder="ID da Sala" value="sala777">
    <div style="display: flex;">
        <button onclick="iniciar(true)" style="background:#4CAF50;">CRIAR SALA</button>
        <button onclick="iniciar(false)" style="background:#2196F3;">ENTRAR NA SALA</button>
    </div>
</div>

<div id="ui" style="display:none;">
    <div id="status">Iniciando...</div>
    <div id="playerCount">Jogadores: 1</div>
</div>

<canvas id="game"></canvas>
<div id="joystick"><div id="stick"></div></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let peer, isHost, myId, roomName;
let players = {};
let connections = []; 
let ready = false;

function iniciar(hostMode) {
    isHost = hostMode;
    const nome = document.getElementById("nameIn").value || "Player";
    roomName = document.getElementById("roomIn").value || "sala777";
    
    // IMPORTANTE: Gerar ID único para cada aba/jogador
    myId = isHost ? roomName : "p_" + Math.random().toString(36).substr(2, 9);
    
    // Criar apenas o MEU player localmente primeiro
    players[myId] = { 
        id: myId, name: nome, 
        x: Math.random() * 400 + 100, y: Math.random() * 400 + 100, 
        color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0') 
    };

    document.getElementById("setup").style.display = "none";
    document.getElementById("ui").style.display = "block";

    peer = new Peer(myId);
    
    peer.on('open', (id) => {
        if(isHost) {
            document.getElementById("status").innerHTML = "<b>HOST</b> | Sala: " + id;
            ready = true;
        } else {
            document.getElementById("status").innerHTML = "Conectando ao Host...";
            setupConn(peer.connect(roomName));
        }
    });

    peer.on('connection', conn => setupConn(conn));
}

function setupConn(conn) {
    conn.on('open', () => {
        if(isHost) {
            connections.push(conn);
        } else {
            connections = [conn];
            ready = true;
            document.getElementById("status").innerHTML = "Conectado!";
        }
        // Envia meus dados para a rede
        conn.send({ type: 'join', p: players[myId] });
    });

    conn.on('data', data => {
        if(data.type === 'join') {
            // Adiciona novo player na lista
            players[data.p.id] = data.p;
            if(isHost) {
                // Host sincroniza todos os players para todos
                broadcast({ type: 'sync_all', all: players });
            }
        }

        if(data.type === 'sync_all') {
            // Recebe a lista completa, mas NÃO sobrescreve a sua própria posição
            for(let id in data.all) {
                if(id !== myId) {
                    players[id] = data.all[id];
                }
            }
        }

        if(data.type === 'move') {
            // Só atualiza se o ID for de outro player
            if(data.id !== myId && players[data.id]) {
                players[data.id].x = data.x;
                players[data.id].y = data.y;
            }
            if(isHost) broadcast(data, conn.peer);
        }
        document.getElementById("playerCount").innerText = "Jogadores: " + Object.keys(players).length;
    });
}

function broadcast(msg, ignoreId) {
    connections.forEach(c => { 
        if(c.peer !== ignoreId && c.open) c.send(msg); 
    });
}

// --- JOYSTICK ---
let joy = { dx: 0, dy: 0 };
let isDragging = false;
const joyEl = document.getElementById("joystick");
const stickEl = document.getElementById("stick");

function handleMove(e) {
    if (!isDragging && !e.touches) return;
    const rect = joyEl.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const x = clientX - rect.left - 60;
    const y = clientY - rect.top - 60;
    const dist = Math.sqrt(x*x + y*y);
    const ang = Math.atan2(y, x);
    const m = Math.min(dist, 40);
    joy.dx = Math.cos(ang) * (m/40);
    joy.dy = Math.sin(ang) * (m/40);
    stickEl.style.transform = `translate(${joy.dx*40}px, ${joy.dy*40}px)`;
}

joyEl.addEventListener("touchstart", (e) => { isDragging = true; handleMove(e); }, {passive: false});
joyEl.addEventListener("touchmove", handleMove, {passive: false});
joyEl.addEventListener("touchend", () => { isDragging = false; joy = {dx:0, dy:0}; stickEl.style.transform = "translate(0,0)"; });
joyEl.addEventListener("mousedown", (e) => { isDragging = true; handleMove(e); });
window.addEventListener("mousemove", (e) => { if(isDragging) handleMove(e); });
window.addEventListener("mouseup", () => { isDragging = false; joy = {dx:0, dy:0}; stickEl.style.transform = "translate(0,0)"; });

function loop() {
    requestAnimationFrame(loop);
    if(!ready || !players[myId]) return;

    // AQUI É O SEGREDO: Só move o personagem que tem o SEU ID
    if(joy.dx !== 0 || joy.dy !== 0) {
        players[myId].x += joy.dx * 5;
        players[myId].y += joy.dy * 5;
        
        const moveData = { type: 'move', id: myId, x: players[myId].x, y: players[myId].y };
        if(isHost) broadcast(moveData, null);
        else if(connections[0]) connections[0].send(moveData);
    }

    ctx.clearRect(0,0,canvas.width, canvas.height);
    
    // Câmera segue apenas o SEU jogador
    const ox = players[myId].x - canvas.width/2;
    const oy = players[myId].y - canvas.height/2;

    for(let id in players) {
        const p = players[id];
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x - ox, p.y - oy, 25, 0, Math.PI*2);
        ctx.fill();
        
        // Nome em cima do boneco
        ctx.fillStyle = "black";
        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        ctx.fillText(p.name + (id === myId ? " (Você)" : ""), p.x - ox, p.y - oy - 35);
    }
}
loop();
</script>
</body>
</html>
